# WakeChamber — SPARTA (20 Jan 2025)
# Robust fix: de-align grid + micro-rotate & shift wafer at runtime (move_surf).
# Also dump the transformed wafer so we can verify it is no longer axis-aligned.

shell mkdir -p data/tmp
shell mkdir -p dump

# --- deterministic seed and 3D ---
seed                12345
dimension           3

# --- numeric tolerance & comm ---
global              gridcut 1.0e-4 comm/sort yes

# --- domain & grid (Plan C: de-align all three axes) ---
boundary            oo oo oo
create_box          -0.55007 1.34993   -0.60009 0.60011   -0.60011 0.60009
create_grid         49 21 21
balance_grid        rcb part

# --- SPECIES / MIXTURE (Argon) ---
species             data/ar.species Ar
mixture             argonmix Ar

# --- global gas settings (debug) ---
global              nrho 1.0e17
global              fnum 1.0e6
global              temp 300.0
global              vstream 0.0 0.0 0.0

# --- geometry (paths are relative to --input-subdir input) ---
variable            surfdir  string "surf"

# Cupola (give it its own group; optional but tidy)
read_surf           ${surfdir}/cupola.surf group cupola

# Wafer: read into group "wafer" (no transforms here)
read_surf           ${surfdir}/wafer_300mm.surf group wafer

# NOW apply transforms robustly (Plan A, runtime):
#  1) tiny yaw about z (+0.1°) to break x/y coplanarity
#  2) tiny tilt about x (+0.05°) to kill z-plane coincidences
#  3) micro-translate to decorrelate any lingering edges
# Use connect yes to preserve watertightness after move (safe for a single object).
move_surf           wafer rotate 0.1  0 0 1   0 0 0  connect yes
move_surf           wafer rotate 0.05 1 0 0   0 0 0  connect yes
move_surf           wafer trans  2.0e-4 1.0e-4 1.0e-4 connect yes

# Optional: write the post-transform wafer to verify it's no longer axis-aligned
write_surf          dump/wafer_wake_aftermove.surfs

# --- surface interactions ---
surf_collide        diffuse 300.0
surf_modify         all collide diffuse

# --- collisions (VSS table) ---
collide             vss
collide_modify      vss file data/ar.vss
collide_modify      nevery 1

# --- groups & stats ---
group               gall grid all
stats               100
stats_style         step np time cpu

# --- temperature compute (global scalar) ---
compute             tgas temp
variable            T       equal c_tgas
variable            step    equal step
variable            time    equal time

# --- diagnostics: grid number density and scalar reductions ---
compute             gNrho_all grid gall nrho
compute             R_all reduce ave c_gNrho_all[1]
variable            Rfree   equal c_R_all
variable            Rwake   equal c_R_all
variable            ratio   equal c_R_all/(c_R_all+1.0e-30)
variable            deficit equal 0.0

# --- wafer-hit sampling (surface collisions) ---
dump                d_hits surf 200 dump/wafer_hits.csv id x y z vx vy vz
dump_modify         d_hits append yes

# --- light grid dump ---
dump                d_grid grid 500 dump/wake_grid.csv id x y z
dump_modify         d_grid append yes

# --- CSV diagnostics (variables only) ---
fix                 fdiag print 100 "${step},${time},${Rfree},${Rwake},${ratio},${deficit},${T}" \
                    file data/tmp/wake_diag.csv \
                    title "step,time,Rfree,Rwake,ratio,deficit,temp" screen no

# --- short warmup + short production (OK with your driver) ---
run                 500
run                 2000


-------------------------------------------------------------------------------------------------------------------

# EffusionCell — SPARTA (20 Jan 2025)
# Robust fix: same wafer transform workflow as wake; keep de-aligned grid.

shell mkdir -p data/tmp
shell mkdir -p dump

# --- deterministic seed and 3D ---
seed                54321
dimension           3

# --- numeric tolerance & comm ---
global              gridcut 1.0e-4 comm/sort yes

# --- domain & grid (Plan C: de-align all three axes) ---
boundary            oo oo oo
create_box          -0.55007 1.34993   -0.60009 0.60011   -0.60011 0.60009
create_grid         49 21 21
balance_grid        rcb part

# --- SPECIES / MIXTURE (Argon) ---
species             data/ar.species Ar
mixture             argonmix Ar

# --- hot source settings (debug-fast) ---
global              nrho 5.0e18
global              fnum 1.0e5
global              temp 1000.0
global              vstream 0.0 0.0 400.0

# --- geometry ---
variable            surfdir  string "surf"
read_surf           ${surfdir}/cupola.surf group cupola
read_surf           ${surfdir}/wafer_300mm.surf group wafer

# Apply identical robust transforms as in wake:
move_surf           wafer rotate 0.1  0 0 1   0 0 0  connect yes
move_surf           wafer rotate 0.05 1 0 0   0 0 0  connect yes
move_surf           wafer trans  2.0e-4 1.0e-4 1.0e-4 connect yes

# Optional: write the post-transform wafer to verify geometry
write_surf          dump/wafer_eff_aftermove.surfs

# --- surface interactions ---
surf_collide        diffuse 300.0
surf_modify         all collide diffuse

# --- source: emit from zlo face; flux set by mixture + globals above ---
fix                 source emit/face argonmix zlo

# --- collisions (VSS table) ---
collide             vss
collide_modify      vss file data/ar.vss
collide_modify      nevery 1

# --- stats & temperature ---
stats               100
stats_style         step np time cpu
compute             tgas temp
variable            T       equal c_tgas
variable            step    equal step
variable            time    equal time

# --- grid diagnostics (use all cells) ---
group               gall grid all
compute             gNrho_all grid gall nrho
compute             R_all reduce ave c_gNrho_all[1]
variable            Rfree   equal c_R_all
variable            Rwake   equal c_R_all
variable            ratio   equal c_R_all/(c_R_all+1.0e-30)
variable            deficit equal 0.0

# --- wafer hits + simple grid dump ---
dump                d_hits surf 200 dump/eff_wafer_hits.csv id x y z vx vy vz
dump_modify         d_hits append yes

dump                d_grid grid 500 dump/eff_grid.csv id x y z
dump_modify         d_grid append yes

# --- CSV diagnostics (variables only) ---
fix                 fdiag print 100 "${step},${time},${Rfree},${Rwake},${ratio},${deficit},${T}" \
                    file data/tmp/effusion_diag.csv \
                    title "step,time,Rfree,Rwake,ratio,deficit,temp" screen no

# --- short warmup + short production ---
run                 300
run                 1200
